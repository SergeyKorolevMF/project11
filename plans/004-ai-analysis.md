# План 004: AI Анализ заметок и Кастомные промпты

## Цель (Objective)
Внедрить AI-анализ (GPT-4o-mini) для каждой заметки, чтобы автоматически извлекать структуру (настроение, задачи, итоги) на основе настраиваемого промпта.

## Шаги (Proposed Steps)

1.  **База данных (Models):**
    *   Обновить модель `Person`: добавить поле `system_prompt` (Text, default=Standard Prompt).
    *   Обновить модель `MeetingNote`: добавить поле `ai_summary` (JSON или Text) для сохранения результата анализа.
    *   *Миграция:* Так как это SQLite MVP, просто добавим поля. Если таблица уже есть, Tortoise может не обновить её автоматически без aerich. *Решение:* Для MVP, если возникнет ошибка, можно удалить файл БД (данных мало) или попытаться добавить поля (Tortoise `generate_schemas` обычно делает `CREATE TABLE IF NOT EXISTS`, но не `ALTER`). В крайнем случае удалим `db.sqlite3`.

2.  **LLM Сервис (`services/llm.py`):**
    *   Установить `openai`.
    *   Написать функцию `analyze_note(text: str, prompt: str) -> dict`.
    *   Промпт должен просить вернуть JSON с полями: `mood`, `summary`, `action_items`, `positive`, `negative`.

3.  **Хендлеры (`handlers/notes.py`):**
    *   В `process_note_text`:
        1.  Сохранить сырую заметку.
        2.  Отправить "⏳ Анализирую..."
        3.  Вызвать `analyze_note`.
        4.  Сохранить результат в БД.
        5.  Отредактировать сообщение с результатами анализа и тегом `#PersonName`.

4.  **Конфигурация:**
    *   Добавить `OPENAI_API_KEY` в `config.py` и `.env`.

## Риски
*   Отсутствие API ключа.
*   Ошибки парсинга JSON от LLM.

## Стратегия отката
*   Отключить вызов `analyze_note` в хендлере.

